<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>批量扫码工具</title>
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --ios-blue: #007AFF;
            --ios-gray: #F2F2F7;
        }

        body {
            margin: 0;
            padding: 16px;
            background: var(--ios-gray);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #preview-container {
            width: 512px;
            height: 512px;
            margin: 20px 0;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            position: relative;
        }

        #preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .button-container {
            width: 100%;
            max-width: 512px;
            margin-top: 20px;
        }

        .ios-button {
            width: 100%;
            padding: 18px;
            background: var(--ios-blue);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 18px;
            margin: 8px 0;
        }

        /* 其他样式保持原有优化 */
    </style>
</head>
<body>
    <div id="preview-container">
        <video id="preview"></video>
    </div>

    <div class="button-container">
        <button class="ios-button" id="scanBtn">开始扫描</button>
        <button class="ios-button" id="exportBtn" style="background: #34C759;">导出结果</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script>
        let mediaStream = null;
        let isScanning = false;
        let audioContext = null;

        // 修复 1：直接绑定事件
        document.getElementById('scanBtn').addEventListener('click', toggleScan);
        document.getElementById('exportBtn').addEventListener('click', exportData);

        async function toggleScan() {
            if (!isScanning) {
                await startScan();
                this.textContent = '停止扫描';
            } else {
                stopScan();
                this.textContent = '开始扫描';
            }
            isScanning = !isScanning;
        }

        async function startScan() {
            try {
                // 修复 3：延迟音频初始化
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                const video = document.getElementById('preview');
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { exact: 512 },
                        height: { exact: 512 }
                    }
                });
                
                // 修复 2：强制视频尺寸
                video.width = 512;
                video.height = 512;
                video.srcObject = mediaStream;
                await video.play();
                scanFrame(video);
            } catch (err) {
                alert('摄像头错误: ' + err.message);
            }
        }

        function scanFrame(video) {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const context = canvas.getContext('2d');
            
            context.drawImage(video, 0, 0);
            const imageData = context.getImageData(0, 0, 512, 512);
            const code = jsQR(imageData.data, 512, 512);

            if (code) {
                playBeep();
                console.log('扫描到:', code.data); // 实际应更新结果列表
            }
            requestAnimationFrame(() => scanFrame(video));
        }

        function playBeep() {
            if (!audioContext) return;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        function stopScan() {
            mediaStream?.getTracks().forEach(track => track.stop());
        }
    </script>
</body>
</html>
